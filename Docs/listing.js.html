<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: listing.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: listing.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * Express application for serving static files and handling API requests.
 * @module API
 */

const express = require("express");
const router = express.Router();
var bodyParser = require("body-parser");
router.use(bodyParser.urlencoded({ extended: true })).use(bodyParser.json());
const db = require("./db").db;
const multer = require("multer");
const sharp = require("sharp");
const { encode } = require("blurhash");
const path = require("path");

const imageStorage = multer.diskStorage({
  destination: "./img/", // Set the directory where uploaded files will be stored
  filename: (req, file, callback) => {
    // Generate a unique filename for each uploaded file
    const uniqueSuffix = Date.now() + "-" + Math.round(Math.random() * 1e9);
    callback(
      null,
      file.fieldname + "-" + uniqueSuffix + path.extname(file.originalname)
    );
  },
});

const imageUpload = multer({
  storage: imageStorage,
  limits: {
    fileSize: 10 * 1024 * 1024, // Adjust the file size limit as needed
  },
}).any(); // Use upload.any() to accept any type of field

/**
 * POST request endpoint for creating a new listing.
 *
 * @function
 * @name createListing
 *
 * @param {Object} req - Express.js request object with a JSON body containing 'price', 'images', 'title', 'description', and 'userName'.
 * @param {Object} res - Express.js response object.
 *
 * @example
 * // Sample HTTP POST request to '/api/createListing'
 * const requestPayload = {
 *   "price": 100.0,
 *   "images": [image1_in_binary, image2_in_binary],
 *   "title": "Sample Listing",
 *   "description": "This is a sample listing.",
 *   "userName": "sampleUser"
 * };
 * const createListingResponse = await fetch(`${serverIp}/api/createListing`, {
 *     method: "POST",
 *     headers: {
 *       "Content-Type": "application/json",
 *     },
 *     body: JSON.stringify(requestPayload),
 *   });
 *
 * if (createListingResponse.status === 201) {
 *     const responsePayload = await createListingResponse.json();
 *     console.log("Listing created successfully with ID:", responsePayload.listingId);
 * } else {
 *     console.log("Error creating listing");
 * }
 */
router.post("/createListing", imageUpload, function (req, res) {
  const { price, title, description, username } = req.body;
  const images = req.files;

  const sqlTimeStamp = new Date().toISOString().slice(0, 19).replace("T", " ");

  try {
    // Insert the listing into the Listings table
    db.run(
      "INSERT INTO Listings (price, title, description, userName, postDate) VALUES (?, ?, ?, ?, ?)",
      [price, title, description, username, sqlTimeStamp],
      function (err) {
        if (err) {
          console.error("Error querying the database:", err);
          return res.status(500).json({ error: "Internal Server Error" });
        }

        const listingId = this.lastID;
        const componentX = req.body.componentX ?? 4;
        const componentY = req.body.componentY ?? 3;

        // Insert images into the Images table
        if (images.length > 0) {
          images.forEach(async (image) => {
            // console.log(image);
            const imagePath = "img/" + image.filename;

            db.run(
              "INSERT INTO Images (listingId, ImageURI) VALUES (?, ?)",
              [listingId, image.filename],
              (err) => {
                if (err) {
                  console.error("Error querying the database:", err);
                  return res
                    .status(500)
                    .json({ error: "Internal Server Error" });
                }
                // console.log(`Inserted image ${image.originalname}`);
              }
            );
          });
        }
        return res.status(201).json({
          message: "Listing created successfully",
          listingId: listingId,
        });
      }
    );
  } catch (err) {
    return res.status(500).json({ error: err });
  }
});

/**
 * GET request endpoint at /api/listings for retrieving a list of all listings.
 *
 * @function
 * @name getListings
 *
 * @param {Object} req - Express.js request object.
 * @param {Object} res - Express.js response object.
 *
 * @example
 * // Sample HTTP GET request to '/api/listings'
 * const listingsResponse = await fetch(`${serverIp}/api/listings`, {
 *     method: "GET",
 *     headers: {
 *       "Content-Type": "application/json",
 *     },
 *   });
 *
 * if (listingsResponse.status === 200) {
 *     const listingsData = await listingsResponse.json();
 *     console.log("List of Listings:", listingsData);
 * } else {
 *     console.log("Error retrieving listings");
 * }
 */
router.get("/listings", async function (req, res) {
  try {
    const listingsResult = await new Promise((resolve, reject) => {
      // First query
      db.all("SELECT * FROM Listings ORDER BY ListingId DESC", (err, rows) => {
        if (err) {
          console.error("Error querying the database (first query):", err);
          reject(err);
        }
        resolve(rows);
      });
    });

    const username = req.query.username;
    const likedListingsResult = await new Promise(() => {
      // First query
      db.all(
        "SELECT ListingId FROM Likes WHERE Username = ? ORDER BY ListingId DESC",
        [username],
        (err, rows) => {
          if (err) {
            console.error("Error querying the database (second query):", err);
            reject(err);
          }
          resolve(rows);
        }
      );
    });

    const imagesResult = await new Promise((resolve, reject) => {
      // Extract the ListingIds from listingsResult
      const listingIds = listingsResult.map((listing) => listing.ListingId);

      if (listingIds.length === 0) {
        // If there are no ListingIds, there's no need to query the Images table.
        resolve([]);
      } else {
        // Generate placeholders for the IN clause based on the number of ListingIds
        const placeholders = listingIds.map(() => "?").join(", ");

        // Second query using placeholders for the IN clause
        db.all(
          `SELECT * FROM Images i WHERE i.ListingId IN (${placeholders})`,
          listingIds,
          (err, rows) => {
            if (err) {
              console.error("Error querying the database (third query):", err);
              reject(err);
            }
            resolve(rows);
          }
        );
      }
    });

    const combinedData = listingsResult.map((listing) => {
      // Check if the listing's ListingId is in the likedListingsResult
      const isLiked = likedListingsResult.some(
        (likedListing) => likedListing.ListingId === listing.ListingId
      );

      const matchingImages = imagesResult
        .filter((image) => image.ListingId === listing.ListingId)
        .map((image) => image.ImageURI);
      return {
        ...listing, // Include all properties from the listing
        images: matchingImages, // Add the matching images
        liked: isLiked,
      };
    });

    // Now you can use both firstQueryResult and secondQueryResult
    return res.status(200).json(combinedData);
  } catch (error) {
    return res.status(500).json({ error: "Internal Server Error" });
  }
});

/**
 * Handles deleting of accounts.
 *
 * @function
 * @name handleDeleteListings
 *
 * @param {Object} req - Express.js request object.
 * @param {Object} res - Express.js response object.
 *
 * @example
 * // Sample HTTP DELETE request to '/api/deletelistings'
 * const deleteListingsResponse = await fetch(`${serverIp}/api/deletelistings`, {
 *     method: "DELETE",
 *     headers: {
 *       "Content-Type": "application/json",
 *     },
 *   });
 *
 * if (deleteListingsResponse.status === 200) {
 *     const deleteListingsData = await deleteListingsResponse.json();
 *     console.log("Listings deleted:", deleteListingsData.message);
 * } else {
 *     console.log("Error deleting listings");
 * }
 */
router.delete("/deletelistings", function (req, res) {
  const listingId = req.query.listingId;

  if (listingId) {
    db.run("DELETE FROM Listings WHERE ListingId = ?", [listingId], (err) => {
      if (err) {
        console.error(`Error deleting listing ${listingId}:`, err);
        return res.status(500).json({ error: "Internal Server Error" });
      }

      return res.status(200).json({ message: `Listing ${listingId} deleted` });
    });
  } else {
    db.run("DELETE FROM Listings", (err) => {
      if (err) {
        console.error("Error deleting all listings:", err);
        return res.status(500).json({ error: "Internal Server Error" });
      }

      return res.status(200).json({ message: "All listings deleted" });
    });
  }
});

/**
 * GET request endpoint at /api/images for retrieving a list of all images or a list of images belonging to a specific listing using the 'listingId' query parameter.
 *
 * @function
 * @name getImages
 *
 * @param {Object} req - Express.js request object.
 * @param {Object} res - Express.js response object.
 *
 * @example
 * // Sample HTTP GET request to '/api/images?listingId=123'
 * const getImagesResponse = await fetch(`${serverIp}/api/images?listingId=123`, {
 *     method: "GET",
 *     headers: {
 *       "Content-Type": "application/json",
 *     },
 *   });
 *
 * if (getImagesResponse.status === 200) {
 *     const imagesData = await getImagesResponse.json();
 *     console.log("Images:", imagesData.Images);
 * } else {
 *     console.log("Error retrieving images");
 * }
 */
router.get("/images", function (req, res) {
  const listingId = req.query.listingId;

  if (listingId) {
    // If 'listingId' is provided as a query parameter, retrieve images for that listing.
    db.all(
      "SELECT * FROM Images WHERE ListingId = ?",
      [listingId],
      (err, rows) => {
        if (err) {
          console.error("Error querying the database:", err);
          return res.status(500).json({ error: "Internal Server Error" });
        }
        return res.status(200).json({ Images: rows });
      }
    );
  } else {
    // If 'listingId' is not provided, retrieve all images.
    db.all("SELECT * FROM Images ORDER BY ImageId DESC", function (err, rows) {
      if (err) {
        console.error("Error querying the database:", err);
        return res.status(500).json({ error: "Internal Server Error" });
      }
      return res.status(200).json({ Images: rows });
    });
  }
});

/**
 * Handles deleting of accounts.
 *
 * @function
 * @name handleDeleteImages
 *
 * @param {Object} req - Express.js request object.
 * @param {Object} res - Express.js response object.
 *
 * @example
 * // Sample HTTP DELETE request to '/api/deleteimages'
 * const deleteImagesResponse = await fetch(`${serverIp}/api/deleteimages`, {
 *     method: "DELETE",
 *     headers: {
 *       "Content-Type": "application/json",
 *     },
 *   });
 *
 * if (deleteImagesResponse.status === 200) {
 *     const deleteImagesData = await deleteImagesResponse.json();
 *     console.log("Images deleted:", deleteImagesData.message);
 * } else {
 *     console.log("Error deleting images");
 * }
 */
router.delete("/deleteimages", function (req, res) {
  const imageId = req.query.imageId;

  if (imageId) {
    db.run("DELETE FROM Images WHERE ImageId = ?", [imageId], (err) => {
      if (err) {
        console.error(`Error deleting image ${imageId}:`, err);
        return res.status(500).json({ error: "Internal Server Error" });
      }

      return res.status(200).json({ message: `image ${imageId} deleted` });
    });
  } else {
    db.run("DELETE FROM images", (err) => {
      if (err) {
        console.error("Error deleting all images:", err);
        return res.status(500).json({ error: "Internal Server Error" });
      }

      return res.status(200).json({ message: "All images deleted" });
    });
  }
});

// Export the router
module.exports = router;
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-API.html">API</a></li><li><a href="module-Database.html">Database</a></li><li><a href="module-Server.html">Server</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 4.0.2</a> on Fri Nov 03 2023 01:41:41 GMT-0700 (Pacific Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
